import{r as c,q as F,y as b,$ as C,j as e,d as E}from"./app-lUInwgRy.js";import{B as w,b as O}from"./button-DzDbuX-O.js";import{I as T}from"./input-C7csDmVJ.js";import{T as G}from"./textarea--eRPwkRH.js";import{R as V,a as v,b as K,I as Q,L as Y,f as Z,T as A}from"./infinite-scroll-DtyaByy6.js";import{f as k}from"./date-cSGFDods.js";import{S as I}from"./scroll-area-Cz3DdDO6.js";import{L as ee}from"./label-BGTeFzqh.js";import{i as y}from"./utils-Cx_fVcGQ.js";import{I as _}from"./consts-CgVw4MgC.js";import{D as se,a as re,b as le}from"./dialog-BWYTjd7C.js";import{S as te}from"./search-BbkOGfC2.js";import{X as ae}from"./x-D5Njf_z9.js";import{F as ie}from"./file-BPGPrkov.js";/* empty css            */import"./createLucideIcon-BKiTtyiR.js";import"./format-B0DXPM4f.js";import"./index-CbDD-pNU.js";import"./index-DHkfiFuj.js";import"./index-DeDYDX0v.js";import"./index-x9bG2h8o.js";import"./index-BEk9yI-S.js";import"./index-B_8yjaaa.js";import"./index-CWdjyrzl.js";const ne=({conversationId:r,initialMessages:a})=>{const[s,i]=c.useState(a),[t,n]=c.useState(!1);F();const S=c.useCallback(async(o,d=[])=>{var x;if(!(!o.trim()&&d.length===0)){n(!0);try{const m=new FormData;m.append("message",o),d.forEach((p,h)=>{m.append(`attachments[${h}]`,p)});const j=await fetch(`/client/conversation/store/${r}`,{method:"POST",body:m,headers:{"X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":((x=document.querySelector('meta[name="csrf-token"]'))==null?void 0:x.getAttribute("content"))||""}});if(!j.ok)throw new Error("Failed to send message");const N=await j.json();if(N.success){const p={id:N.message.id||Date.now(),conversation_id:r,sender:"client",message:o,attachments:d.length>0?JSON.stringify(d.map(h=>h.name)):null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return i(h=>[...h,p]),{success:!0,message:p}}else throw new Error("Server returned error")}catch(m){return console.error("Error sending message:",m),{success:!1,error:m.message}}finally{n(!1)}}},[r]),f=c.useCallback(async()=>{n(!0);try{b.get(`/client/conversation/view/${r}?more=${s.length+10}`,{},{preserveState:!0,preserveScroll:!0,only:["conversationMessage"],onSuccess:o=>{i(o.props.conversationMessage)}})}catch(o){console.error("Error loading more messages:",o)}finally{n(!1)}},[r,s.length]);return{messages:s,sendMessage:S,loadMoreMessages:f,isLoading:t,setMessages:i}};function Oe({hasChat:r,conversations:a,conversation:s,count:i}){const{url:t}=F(),[n,S]=c.useState(""),[f,o]=c.useState(""),[d,x]=c.useState([]),{messages:m,sendMessage:j,isLoading:N}=ne({conversationId:(s==null?void 0:s.id)||0,initialMessages:(s==null?void 0:s.messages)||[]}),p=l=>{S(l.target.value)},h=l=>{o(l.target.value)},$=c.useRef(null),P=l=>{const u=l.target.files||[];x([...d,...u])};c.useRef(null);const L=c.useRef(null);c.useEffect(()=>{const l=L.current,u=$.current;l&&u&&(t.includes("view")?u.focus():l.focus(),u.value="")},[]);const[U,M]=C.useState(!1),[R,X]=C.useState(Number(i)-Number(m.length)>0),g=c.useRef(null),z=()=>{g.current&&g.current.scrollToTop()},W=()=>{g.current&&g.current.scrollToBottom()};return e.jsx("div",{className:"flex flex-col h__min__70",children:e.jsxs(V,{direction:"horizontal",className:"grid flex-1 grid-cols-2 border-t h__min__70",children:[e.jsx(v,{className:"overflow-scroll border-b border-l h__min__70",children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("form",{className:"flex gap-0 p-4 border-b",onSubmit:l=>{l.preventDefault(),t.includes("view")?b.get(`/client/conversation/view/${s==null?void 0:s.id}?search=${n}`):b.get(`/client/conversation/influencers?search=${n}`)},children:[e.jsx(w,{type:"submit",variant:"outline",className:"rounded-tr-none rounded-br-none",children:e.jsx(te,{className:"w-4 h-4"})}),e.jsx(T,{type:"search",className:"w-full max-w-sm text-sm rounded-tl-none rounded-bl-none",placeholder:"Search chats",value:n,onChange:p,ref:L})]}),e.jsx(I,{className:"flex-1 overflow-y-auto",children:e.jsx("ul",{className:"divide-y",children:a.map(l=>e.jsx(me,{conversation:l,isClicked:l.id===(s==null?void 0:s.id)}))})})]})}),e.jsx(K,{}),e.jsxs(v,{className:"flex flex-col border-b border-r h__min__70",children:[r?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center p-4 space-x-4 border-b h-[72px] ",children:[e.jsx(w,{type:"button",className:"p-0 rounded-full",variant:"ghost",children:e.jsx(E,{className:"w-10 h-10 rounded-full",href:`/influencer/profile/${s==null?void 0:s.influencer.username}/${s==null?void 0:s.influencer.id}`,children:e.jsx("img",{alt:"User avatar",className:"rounded-full aspect-square",height:"40",src:s!=null&&s.influencer.image?`/assets/images/influencer/profile/${s==null?void 0:s.influencer.image}`:"/assets/user_profile.png",width:"40"})})}),e.jsx("h2",{className:"font-semibold",children:(s==null?void 0:s.influencer.firstname)+" "+(s==null?void 0:s.influencer.lastname)})]}),e.jsx(I,{className:"flex flex-col flex-1 w-full",ref:g,children:e.jsx("div",{className:"flex items-end justify-end flex-1 mt-auto messagerie",children:e.jsxs("div",{className:"flex flex-col items-end justify-end w-full gap-2 px-6 py-4 ",children:[e.jsx(Q,{hasMore:R,isLoading:U,threshold:1,next:()=>{M(!0),b.get(`/client/conversation/view/${s==null?void 0:s.id}?more=${Number(m.length)+10}`),M(!1);const l=Number(i)-Number(m.length);X(l>0),z()},children:R&&e.jsx(Y,{className:"w-8 h-8 my-4 animate-spin"})}),[...m].reverse().map(l=>{switch(l.sender){case"client":return e.jsx(oe,{message:l.message,time:String(l.created_at),read:!1,files:l.attachments?JSON.parse(l.attachments):[]},l.id);case"influencer":return e.jsx(D,{message:l.message,time:String(l.created_at),read:!1,files:l.attachments?JSON.parse(l.attachments):[]},l.id);default:return e.jsx(D,{message:l.message,time:String(l.created_at),read:!1},l.id)}})]})})})]}):e.jsx("div",{className:"flex items-center justify-center w-full h-full",children:e.jsx(Z,{src:"https://lottie.host/30849ece-e0e3-4e48-8502-b2fe35128ef3/TS1hX0DOX8.json",background:"transparent",speed:1,style:{width:"350px",height:"350px"},loop:!0,autoplay:!0})}),e.jsxs("div",{className:"flex items-center p-4 space-x-4 border-t min-h-[120px]",children:[e.jsxs(ee,{htmlFor:"file","aria-label":"Attach file",className:O({variant:"ghost"})+"p-0 rounded-full relative w-6 h-6",children:[e.jsx(T,{id:"file",type:"file",multiple:!0,onChange:P,className:"invisible w-0 h-0"}),e.jsx(de,{className:"absolute w-full h-full cursor-pointer"})]}),e.jsxs("div",{className:"flex flex-col flex-1 border-[1px] border-gray-600 rounded-md p-2",children:[e.jsx("div",{className:"flex gap-5",children:d.map((l,u)=>e.jsxs("div",{className:"group w-[60px] h-[60px] flex justify-center items-center hover:bg-primary-foreground",children:[e.jsx(w,{variant:"ghost",className:"hidden group-hover:block",onClick:()=>{x([...d].filter((ue,J)=>J!==u))},children:e.jsx(ae,{className:"w-4 h-4"})}),e.jsx("img",{src:URL.createObjectURL(l),alt:"img",className:"w-full h-full group-hover:hidden"},u)]}))}),e.jsx(G,{className:"flex-1 border-none focus-visible:ring-0 ",placeholder:"Type a message...",value:f,onChange:h,ref:$})]}),e.jsx(w,{type:"button","aria-label":"Send",className:"w-10 h-10",disabled:!f&&d.length===0||N,onClick:async()=>{if(!f.trim()&&d.length===0)return;const l=await j(f,d);l.success?(o(""),x([]),setTimeout(()=>{W()},100)):console.error("Failed to send message:",l.error)},children:e.jsx(ce,{className:"w-4 h-4"})})]})]})]})},"1")}function ce(r){return e.jsxs("svg",{...r,xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"m5 12 7-7 7 7"}),e.jsx("path",{d:"M12 19V5"})]})}function B(r){return e.jsx("svg",{...r,xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"20 6 9 17 4 12"})})}function de(r){return e.jsx("svg",{...r,xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"})})}const me=({conversation:r,isClicked:a})=>e.jsx("li",{className:"",children:e.jsxs(E,{className:`flex items-center p-4 space-x-4 duration-300 hover:bg-primary-foreground hover:text-black ${a?"bg-primary text-white":""}`,href:`/client/conversation/view/${r.id}`,children:[e.jsx("img",{alt:"User avatar",className:"rounded-full",height:"40",src:r!=null&&r.influencer.image?`/assets/images/influencer/profile/${r==null?void 0:r.influencer.image}`:"/assets/user_profile.png",style:{aspectRatio:"40/40",objectFit:"cover"},width:"40"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold",children:r.influencer.firstname+" "+r.influencer.lastname}),e.jsx("p",{className:"text-sm truncate",children:r.last_message.message})]}),e.jsx("time",{className:"text-sm",children:k(String(r.last_message.created_at))})]})}),D=({message:r,read:a,time:s,files:i})=>e.jsxs("div",{className:"flex items-start w-full gap-4",children:[e.jsx("img",{alt:"User avatar",className:"rounded-full",height:"40",src:"/assets/user_profile.png",style:{aspectRatio:"40/40",objectFit:"cover"},width:"40"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:`flex ${i.length>0?"my-3":""} items-center flex-col  `,children:i.filter(t=>!y(t)).map((t,n)=>e.jsx(H,{file:t,self:!1},t+n))}),e.jsx("div",{className:`flex ${i.length>0?"my-3":""} items-center gap-1 flex-wrap `,children:i.filter(t=>y(t)).map((t,n)=>e.jsx(q,{image:t,self:!1},t+n))}),e.jsxs("div",{className:"flex flex-col items-start justify-center gap-2",children:[r&&e.jsx("div",{className:"p-4 bg-gray-100 rounded-lg dark:bg-gray-800 rounded-lg/none",children:e.jsx("p",{className:"text-sm",children:r})}),e.jsxs("time",{className:"flex items-center gap-1 text-xs",children:[a?e.jsx(B,{className:"w-4 h-4"}):e.jsx(A,{className:"w-4 h-4"}),e.jsx("span",{children:a?"read":k(String(s))})]})]})]})]}),oe=({message:r,read:a,time:s,files:i})=>e.jsx("div",{className:"flex items-center justify-end w-full gap-4 ",children:e.jsxs("div",{className:"space-y-2 ",children:[e.jsx("div",{className:`flex ${i.length>0?"my-3":""} items-center flex-col  `,children:i.filter(t=>!y(t)).map((t,n)=>e.jsx(H,{file:t,self:!0},t+n))}),e.jsx("div",{className:`flex ${i.length>0?"my-3":""} items-center gap-1 flex-wrap `,children:i.filter(t=>y(t)).map((t,n)=>e.jsx(q,{image:t,self:!0},t+n))}),e.jsxs("div",{className:"flex flex-col items-end justify-center gap-2",children:[r&&e.jsx("div",{className:"p-4 font-normal text-right text-white rounded-lg bg-primary dark:bg-gray-800 rounded-lg/none w-fit ",children:e.jsx("p",{className:"text-sm",children:r})}),e.jsxs("time",{className:"flex items-center gap-1 text-xs",children:[a?e.jsx(B,{className:"w-4 h-4"}):e.jsx(A,{className:"w-4 h-4"}),e.jsx("span",{children:a?"read":k(String(s))})]})]})]})}),q=({image:r,self:a})=>e.jsx("div",{children:e.jsxs(se,{children:[e.jsxs(re,{children:[" ",e.jsx("img",{src:_+"conversation/"+r,alt:"",className:`object-cover w-16 h-16 border-2 rounded-md aspect-square ${a?"border-primary":""} `})]}),e.jsx(le,{children:e.jsx("img",{src:_+"conversation/"+r,alt:"",className:`object-cover mt-6 rounded-md aspect-square border-1 ${a?"border-primary":""}`})})]})}),H=({file:r,self:a})=>e.jsxs("a",{className:O({variant:"outline"})+`flex gap-2  
                ${a?"border-primary text-primary":""} `,href:_+"conversation/"+r,download:r,children:[e.jsx(ie,{className:"w-5 h-5"}),e.jsx("p",{className:"text-sm font-medium leading-none",children:r})]});export{Oe as default};
